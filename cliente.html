<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNI Proctoring - FIEE</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    
    <style>
        :root { --primary: #7b1fa2; --bg: #f3f4f6; --text: #1f2937; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; }
        
        /* Panel Lateral */
        .sidebar { width: 300px; background: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .logo-uni { font-size: 24px; font-weight: bold; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .student-info { background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 20px; }
        .student-info p { margin: 5px 0; font-size: 14px; }
        
        /* √Årea Principal */
        .main-content { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .video-container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }
        video { border-radius: 8px; transform: scaleX(-1); width: 640px; background: #000; }
        canvas { display: none; } /* Oculto, solo para extraer matrices y fotos */
        
        /* Indicadores */
        .status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 50px; font-weight: 600; margin-top: 20px; font-size: 15px; transition: all 0.3s; }
        .status-ok { background: #d1fae5; color: var(--success); }
        .status-alert { background: #fee2e2; color: var(--danger); animation: pulse 1s infinite; }
        
        /* Log de eventos */
        .event-log { width: 640px; margin-top: 20px; background: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .log-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; color: #4b5563; display: flex; justify-content: space-between; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-uni">üèõÔ∏è UNI Proctoring</div>
        <div class="student-info">
            <h3 style="margin-top:0;">Datos del Estudiante</h3>
            <p><strong>Nombre:</strong> Richard Gonz√°lez</p>
            <p><strong>Matr√≠cula:</strong> A123456</p>
            <p><strong>Carrera:</strong> Ing. de Sistemas</p>
            <p><strong>Examen:</strong> POO</p>
        </div>
        <div style="flex:1;"></div>
        <p style="font-size: 12px; color: #9ca3af; text-align: center;">Motor de Inferencia Edge V2.0</p>
    </div>

    <div class="main-content">
        <div class="video-container">
            <video id="video-alumno" width="640" height="480" autoplay playsinline></video>
            <canvas id="canvas-oculto" width="640" height="480"></canvas>
        </div>
        
        <div id="estado" class="status-badge status-ok">
            ‚è≥ Inicializando tensores...
        </div>

        <div class="event-log">
            <h4 style="margin-top:0; color: #374151;">√öltimos Eventos Detectados</h4>
            <div id="lista-eventos">
                <div class="log-item"><span style="color: #10b981;">Conexi√≥n segura establecida</span> <span>Ahora</span></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURACI√ìN Y VARIABLES GLOBALES
        // ==========================================
        const DATOS_ALUMNO = { uid: "A123456", nombre: "Richard Gonz√°lez", materia: "POO" };
        const video = document.getElementById('video-alumno');
        const canvas = document.getElementById('canvas-oculto');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        let enviandoAlerta = false;

        // ==========================================
        // 2. SISTEMA DE ALERTAS (UI + BACKEND)
        // ==========================================
        function agregarEventoVisual(texto) {
            const lista = document.getElementById('lista-eventos');
            const item = document.createElement('div');
            item.className = 'log-item';
            item.style.color = '#ef4444';
            item.innerHTML = `<span>‚ö†Ô∏è ${texto}</span> <span>${new Date().toLocaleTimeString()}</span>`;
            lista.prepend(item);
            
            const estado = document.getElementById('estado');
            estado.className = 'status-badge status-alert';
            estado.innerHTML = `üî¥ Infracci√≥n: ${texto}`;
            
            setTimeout(() => {
                estado.className = 'status-badge status-ok';
                estado.innerHTML = 'üü¢ Motor de IA Activo - Monitoreo Estable';
            }, 4000);
        }

        async function dispararAlerta(tipoFalta) {
            if (enviandoAlerta) return;
            enviandoAlerta = true;
            
            agregarEventoVisual(tipoFalta);

            // Capturar frame como evidencia
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const fotoBase64 = canvas.toDataURL('image/jpeg', 0.6);

            try {
                await fetch('/api/alerta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        uid: DATOS_ALUMNO.uid,
                        nombre: DATOS_ALUMNO.nombre,
                        materia: DATOS_ALUMNO.materia,
                        tipo_falta: tipoFalta,
                        imagen_b64: fotoBase64
                    })
                });
            } catch (error) {
                console.error("Error contactando al servidor Python:", error);
            }

            setTimeout(() => { enviandoAlerta = false; }, 5000); // Cooldown
        }

        // ==========================================
        // 3. MEDIAPIPE (Mirada Desviada)
        // ==========================================
        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5 });

        faceMesh.onResults((results) => {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const rostro = results.multiFaceLandmarks[0];
                const desviacionX = Math.abs(rostro[468].x - rostro[33].x);
                if (desviacionX < 0.012) {
                    dispararAlerta("Mirada Desviada Detectada");
                }
            }
        });

        // ==========================================
        // 4. MOTOR ONNX RUNTIME (YOLOv8 HARDCORE)
        // ==========================================
        const UMBRAL_CELULAR = 0.55;
        let procesandoYOLO = false;
        let yoloSession = null;

        async function inicializarYOLO() {
            try {
                ort.env.wasm.numThreads = 3; 
                yoloSession = await ort.InferenceSession.create('/static/yolov8n.onnx', { executionProviders: ['wasm'] });
                console.log("‚úÖ Motor YOLO-ONNX cargado exitosamente.");
            } catch (e) {
                console.error("‚ùå Error cargando YOLO. ¬øEst√° yolov8n.onnx en la carpeta correcta?", e);
            }
        }

        async function ejecutarInferenciaYOLO(videoElement) {
            if (!yoloSession || procesandoYOLO) return;
            procesandoYOLO = true;

            try {
                // Pre-procesamiento
                ctx.drawImage(videoElement, 0, 0, 640, 640);
                const imgData = ctx.getImageData(0, 0, 640, 640).data;
                const float32Data = new Float32Array(3 * 640 * 640);
                
                for (let i = 0; i < 640 * 640; i++) {
                    float32Data[i] = imgData[i * 4] / 255.0;                   
                    float32Data[640 * 640 + i] = imgData[i * 4 + 1] / 255.0;   
                    float32Data[2 * 640 * 640 + i] = imgData[i * 4 + 2] / 255.0; 
                }

                // Inferencia Matricial
                const tensor = new ort.Tensor('float32', float32Data, [1, 3, 640, 640]);
                const resultados = await yoloSession.run({ images: tensor });
                
                // Decodificaci√≥n de Tensores
                const salida = resultados.output0.data;
                let maxConfianza = 0;

                for (let index = 0; index < 8400; index++) {
                    const clase_celular_prob = salida[8400 * 71 + index]; // 4 geom + 67 clase
                    if (clase_celular_prob > maxConfianza) {
                        maxConfianza = clase_celular_prob;
                    }
                }

                if (maxConfianza > UMBRAL_CELULAR) {
                    dispararAlerta("Uso de Celular Detectado");
                }

            } catch (error) {
                console.error("Error en inferencia matricial:", error);
            } finally {
                procesandoYOLO = false;
            }
        }

        // ==========================================
        // 5. INICIALIZACI√ìN DE C√ÅMARA
        // ==========================================
        let frameCounter = 0;
        const camera = new Camera(video, {
            onFrame: async () => {
                await faceMesh.send({image: video});
                
                frameCounter++;
                if (frameCounter % 10 === 0) { // Evaluar YOLO ~3 veces por segundo
                    ejecutarInferenciaYOLO(video);
                }
            },
            width: 640,
            height: 480
        });

        // Secuencia de arranque profesional
        inicializarYOLO().then(() => {
            camera.start();
            document.getElementById('estado').innerHTML = 'üü¢ Motor de IA Activo - Monitoreo Estable';
        });

    </script>
</body>
</html>