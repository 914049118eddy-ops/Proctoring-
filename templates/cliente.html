<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Evaluaci√≥n UNI - FIEE</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        :root { --uni: #800000; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: var(--bg); }
        .exam-area { flex: 2; padding: 30px; overflow-y: auto; background: white; border-right: 2px solid #ddd; }
        .sidebar { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; background: white; }
        .privacy-alert { background: #e3f2fd; color: #0d47a1; padding: 15px; border-radius: 8px; font-size: 13px; margin-bottom: 20px; border-left: 5px solid #2196f3; }
        video { width: 100%; border-radius: 12px; transform: scaleX(-1); background: #000; margin-bottom: 10px; }
        .status-badge { padding: 10px 20px; border-radius: 50px; font-weight: bold; width: 100%; text-align: center; box-sizing: border-box; }
        .status-ok { background: #d1fae5; color: #10b981; border: 1px solid #10b981; }
        .status-alert { background: #fee2e2; color: #ef4444; border: 1px solid #ef4444; }
        .btn-finish { background: #28a745; color: white; padding: 15px; width: 100%; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; }
        .btn-finish:hover { background: #218838; }
        .log-box { width: 100%; margin-top: 15px; height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; font-size: 12px; box-sizing: border-box; }
        
        /* Estilos Quiz Interactivo */
        .question-card { background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .question-card p { font-weight: bold; margin-top: 0; color: #333; font-size: 16px; }
        .option-label { display: block; padding: 10px 15px; margin: 8px 0; background: white; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .option-label:hover { background: #f1f5f9; }
        .option-label input { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="exam-area">
        <div class="privacy-alert">
            üõ°Ô∏è <b>Aviso de Confidencialidad:</b> Los docentes no pueden ver tu c√°mara en tiempo real. El sistema solo captura im√°genes puntuales si la IA detecta anomal√≠as. Tu privacidad es nuestra prioridad.
        </div>

        <h2 style="color: var(--uni); border-bottom: 2px solid var(--uni); padding-bottom: 10px;">
            üìù Sala de Evaluaci√≥n: {{ sala }}
        </h2>
        
        {% if config.tipo == 'tradicional' %}
            <img src="{{ config.contenido }}" style="width: 100%; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
            <h3>Respuestas:</h3>
            <textarea id="resp_txt" style="width:100%; height:150px; padding:15px; border-radius:8px; border: 1px solid #ccc; font-family: inherit;" placeholder="Escribe aqu√≠ el desarrollo o las respuestas finales de tu examen..."></textarea>
        
        {% else %}
            <div id="quiz-interactivo">
                {% for preg in config.preguntas %}
                <div class="question-card">
                    <p>{{ loop.index }}. {{ preg.pregunta }}</p>
                    {% for opc in preg.opciones %}
                    <label class="option-label">
                        <input type="radio" name="preg_{{ loop.index0 }}" value="{{ opc }}"> {{ opc }}
                    </label>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <div class="sidebar">
        <div style="background: var(--uni); color: white; width: 100%; padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 15px; box-sizing: border-box;">
            <strong style="font-size: 16px;">{{ nombre }}</strong><br>
            <span style="font-size: 12px; opacity: 0.8;">ID: {{ uid }}</span>
        </div>

        <video id="video-alumno" autoplay playsinline></video>
        <canvas id="canvas-oculto" style="display:none" width="640" height="480"></canvas>
        <div id="estado" class="status-badge status-ok">‚è≥ Inicializando C√°mara...</div>
        
        <form action="/finalizar" method="post" id="form-fin" style="width:100%">
            <input type="hidden" name="uid" value="{{ uid }}">
            <input type="hidden" name="respuestas" id="input_respuestas">
            <button type="submit" class="btn-finish" onclick="prepararEnvio()">üèÅ ENTREGAR EXAMEN</button>
        </form>
        
        <div class="log-box">
            <strong style="color: #666; display: block; margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">Bit√°cora de IA</strong>
            <div id="lista-eventos"></div>
        </div>
    </div>

    <script>
        const DATOS_ALUMNO = { uid: "{{ uid }}", nombre: "{{ nombre }}", sala: "{{ sala }}" };
        
        function prepararEnvio() {
            let data = {};
            // Si es tradicional
            if (document.getElementById('resp_txt')) {
                data.texto = document.getElementById('resp_txt').value;
            } else {
                // Si es interactivo, buscar los radio buttons seleccionados
                const questions = document.querySelectorAll('.question-card');
                questions.forEach((q, index) => {
                    const checked = q.querySelector(`input[name="preg_${index}"]:checked`);
                    data[`Pregunta_${index+1}`] = checked ? checked.value : "Sin responder";
                });
            }
            document.getElementById('input_respuestas').value = JSON.stringify(data);
        }
    </script>
    <script src="/static/js/motor_ia.js"></script>
</body>
</html>
