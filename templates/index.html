<!DOCTYPE html>
<html lang="es">
    
<head>
    <meta charset="UTF-8">
    <title>Plataforma Acad√©mica FIEE - UNI</title>
    <style>
        :root { --uni: #800000; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        
        .btn { background: var(--uni); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; box-sizing: border-box; }
        .btn:hover { background: #600000; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .registro-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .card-login { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 360px; border-top: 6px solid var(--uni); }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #777; font-weight: bold; }
        .tab.active { color: var(--uni); border-bottom: 3px solid var(--uni); }
        .form-view { display: none; }
        .form-view.active { display: block; }
        
        .examen-layout { display: flex; height: 100vh; overflow: hidden; width: 100vw; }
        .examen-area { flex: 2; padding: 30px; overflow-y: auto; background: white; border-right: 2px solid #ddd; }
        .proctoring-sidebar { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; background: #fff; }
        #video-alumno { width: 100%; border-radius: 12px; transform: scaleX(-1); background: #000; }
        .status-badge { padding: 10px 20px; border-radius: 50px; font-weight: bold; width: 100%; text-align: center; margin-top:10px; box-sizing: border-box; border: 1px solid #ccc; }
        .log-box { width: 100%; margin-top: 15px; height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; font-size: 12px; box-sizing: border-box; }
        .pregunta-card { background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 10px; margin-bottom: 20px; }

        .dash-body { padding: 20px; overflow-y: auto; height: 100vh; box-sizing: border-box;}
        .header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--uni); padding-bottom: 10px; margin-bottom: 20px; align-items: center;}
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border-top: 4px solid var(--uni); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-card h2 { margin: 0; color: var(--uni); font-size: 28px; }
        .dash-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .panel { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .evidencia-card { display: flex; border: 1px solid #fee2e2; border-radius: 8px; overflow: hidden; margin-bottom: 15px; }
        .evidencia-card img { width: 120px; height: 90px; object-fit: cover; }
    </style>
</head>
<body>

    {% if vista == 'registro' %}
    <div class="registro-container">
        <div class="card-login">
            <h2 style="text-align: center; color: var(--uni); margin-top:0;">SISTEMA PROCTORING</h2>
            <div class="tabs">
                <div id="tab-est" class="tab active" onclick="cambiarTab('est')">Estudiante</div>
                <div id="tab-doc" class="tab" onclick="cambiarTab('doc')">Docente</div>
            </div>
            
            <form id="form-est" class="form-view active" action="/procesar_acceso" method="post">
                <input type="hidden" name="role" value="estudiante">
                <input type="text" name="nombre" placeholder="Nombres Completos" required>
                <input type="text" name="uid" placeholder="C√≥digo UNI (Ej: 20261234A)" required>
                <input type="text" name="sala" placeholder="C√≥digo de la Sala" required>
                <button type="submit" class="btn">Ingresar al Examen</button>
            </form>
            
            <form id="form-doc" class="form-view" action="/procesar_acceso" method="post">
                <input type="hidden" name="role" value="docente">
                <input type="text" name="docente" placeholder="Tu Nombre (Ej: Ing. P√©rez)" required>
                <input type="password" name="password" placeholder="Contrase√±a Institucional" required>
                <button type="submit" class="btn" style="background:#333;">Acceso Docente</button>
            </form>
        </div>
    </div>
    <script>
        function cambiarTab(tipo) {
            document.getElementById('form-est').classList.toggle('active', tipo==='est');
            document.getElementById('form-doc').classList.toggle('active', tipo==='doc');
            document.getElementById('tab-est').classList.toggle('active', tipo==='est');
            document.getElementById('tab-doc').classList.toggle('active', tipo==='doc');
        }
    </script>
    {% endif %}


    {% if vista == 'examen' %}
    <div class="examen-layout">
        <div class="examen-area">
            <h2 style="color: var(--uni);">Sala de Evaluaci√≥n: {{ sala }}</h2>
            <div style="background:#e3f2fd; padding:10px; border-radius:5px; font-size:12px; margin-bottom:15px;">
                üõ°Ô∏è La c√°mara se procesa localmente. Tu privacidad est√° garantizada.
            </div>

            {% if config.tipo == 'tradicional' %}
                <img src="{{ config.url }}" style="width: 100%; border: 1px solid #ddd; border-radius: 8px;">
                <textarea id="resp_txt" style="height: 150px; margin-top: 15px;" placeholder="Escribe tu desarrollo aqu√≠..."></textarea>
            {% else %}
                <div id="quiz-interactivo">
                    {% for preg in config.preguntas %}
                    <div class="pregunta-card">
                        <p style="margin-top:0;"><b>{{ loop.index }}. {{ preg.pregunta }}</b></p>
                        {% for opc in preg.opciones %}
                        <label style="display:block; padding:8px; border:1px solid #eee; margin-top:5px; border-radius:5px; cursor:pointer;">
                            <input type="radio" name="preg_{{ loop.index0 }}" value="{{ opc }}"> {{ opc }}
                        </label>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="proctoring-sidebar">
            <div style="background:var(--uni); color:white; width:100%; padding:10px; text-align:center; border-radius:8px; margin-bottom:10px; box-sizing:border-box;">
                <b>{{ nombre }}</b><br><small>{{ uid }}</small>
            </div>
            
            <video id="video-alumno" autoplay playsinline></video>
            <canvas id="canvas-oculto" style="display:none" width="640" height="480"></canvas>
            <div id="estado" class="status-badge" style="color:#f59e0b; border-color:#f59e0b;">‚è≥ Iniciando IA...</div>
            
            <form action="/finalizar_evaluacion" method="post" style="width: 100%;" onsubmit="recopilarRespuestas()">
                <input type="hidden" name="uid" value="{{ uid }}">
                <input type="hidden" name="respuestas" id="input_respuestas">
                <button type="submit" class="btn" style="background:#10b981; margin-top:15px;">üèÅ ENTREGAR EXAMEN</button>
            </form>

            <div class="log-box">
                <b style="color:#666;">Bit√°cora de IA</b><hr style="border:0; border-top:1px solid #eee;">
                <div id="lista-eventos"></div>
            </div>
        </div>
    </div>
    <script>
        const DATOS_ALUMNO = { uid: "{{ uid }}", nombre: "{{ nombre }}", sala: "{{ sala }}" };
        function recopilarRespuestas() {
            let data = {};
            if (document.getElementById('resp_txt')) {
                data.texto = document.getElementById('resp_txt').value;
            } else {
                document.querySelectorAll('.pregunta-card').forEach((q, index) => {
                    const checked = q.querySelector(`input[name="preg_${index}"]:checked`);
                    data[`Pregunta_${index+1}`] = checked ? checked.value : "Vacio";
                });
            }
            document.getElementById('input_respuestas').value = JSON.stringify(data);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script src="/static/js/motor_ia.js"></script>
    {% endif %}


    {% if vista == 'dashboard' %}
    <div class="dash-body">
        <div class="header">
            <div>
                <h1 style="color: var(--uni); margin: 0;">üë®‚Äçüè´ Panel de Control</h1>
                <small style="color:#666;">Sesi√≥n iniciada por: <b>{{ docente }}</b></small>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="location.reload()" style="width:auto;">üîÑ Refrescar</button>
                <a href="/descargar_dataset?password={{ password }}" class="btn" style="background:#10b981; text-decoration:none; width:auto; text-align:center;">üì• CSV</a>
                
                <form action="/limpiar_auditoria" method="post" onsubmit="return confirm('¬øSeguro que deseas borrar todas las fotos e incidencias?');">
                    <input type="hidden" name="password" value="{{ password }}">
                    <input type="hidden" name="docente" value="{{ docente }}">
                    <button type="submit" class="btn" style="background:#ef4444; width:auto;">üóëÔ∏è Limpiar Evidencias</button>
                </form>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><h2>{{ stats.total_alumnos }}</h2><p>ALUMNOS</p></div>
            <div class="stat-card"><h2>{{ stats.activos }}</h2><p>RINDIENDO üü¢</p></div>
            <div class="stat-card"><h2>{{ stats.total_alertas }}</h2><p>INCIDENTES üö®</p></div>
            <div class="stat-card"><h2 style="color:{{ 'red' if stats.camaras_tapadas > 0 else 'green' }}">{{ stats.camaras_tapadas }}</h2><p>C√ÅMARAS TAPADAS ‚õî</p></div>
        </div>

        <div class="dash-layout">
            <div class="panel">
                <h3 style="margin-top:0; color:var(--uni); border-bottom: 1px solid #eee;">1. Crear Sala</h3>
                <form action="/crear_sala" method="post" style="display:flex; gap:5px;">
                    <input type="hidden" name="password" value="{{ password }}">
                    <input type="hidden" name="docente" value="{{ docente }}">
                    <input type="text" name="nombre_sala" placeholder="Ej: EXAMEN_POO" required>
                    <button type="submit" class="btn" style="width:80px;">Abrir</button>
                </form>

                <h3 style="margin-top:30px; color:var(--uni); border-bottom: 1px solid #eee;">2. Configurar Test</h3>
                <form action="/configurar_lms" method="post">
                    <input type="hidden" name="password" value="{{ password }}">
                    <input type="hidden" name="docente" value="{{ docente }}">
                    <select name="tipo">
                        <option value="tradicional">Imagen / PDF</option>
                        <option value="interactivo">Test Interactivo (JSON)</option>
                    </select>
                    <textarea name="contenido" rows="5" placeholder="Pega el link de la imagen o el JSON del Test" required></textarea>
                    <button type="submit" class="btn" style="background:#10b981;">Publicar Examen</button>
                </form>
            </div>

            <div class="panel">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="margin-top:0; color:var(--uni);">üö® Evidencias de IA</h3>
                        {% for item in incidencias %}
                        <div class="evidencia-card">
                            <img src="/ver_evidencia/{{ item.Ruta.split('/')[-1] }}">
                            <div style="padding: 10px; font-size:12px;">
                                <b style="color:#ef4444;">{{ item.Falta }}</b><br>
                                <b>{{ item.Nombre }}</b><br>
                                <span style="color:#666">{{ item.Sala }} | {{ item.Fecha }}</span>
                            </div>
                        </div>
                        {% else %}
                        <p style="color:#999; font-size:13px;">Todo correcto.</p>
                        {% endfor %}
                    </div>

                    <div>
                        <h3 style="margin-top:0; color:var(--uni);">üìë Entregas</h3>
                        {% for res in respuestas %}
                        <div style="background:#f8fafc; border-left:4px solid #10b981; padding:10px; margin-bottom:10px; border-radius:4px; font-size:12px;">
                            <b>{{ res.ID }}</b> <span style="color:#666; float:right;">{{ res.Fecha }}</span><br>
                            <hr style="border:0; border-top:1px solid #ddd; margin: 5px 0;">
                            {% for p, r in res.Detalle.items() %}
                                <b>{{ p }}:</b> {{ r }}<br>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p style="color:#999; font-size:13px;">A√∫n no hay entregas.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}


    {% if vista == 'confirmacion' %}
    <div style="display:flex; justify-content:center; align-items:center; height:100vh;">
        <div style="background:white; padding:40px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1); text-align:center;">
            <h1 style="color:#10b981; margin-top:0;">‚úÖ Evaluaci√≥n Completada</h1>
            <p style="color:#555;">Tus respuestas han sido enviadas.</p>
            <button onclick="location.href='/'" class="btn" style="margin-top:20px; width:auto; padding:10px 30px;">Volver al Portal</button>
        </div>
    </div>
    {% endif %}

</body>
</html>
