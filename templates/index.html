<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Plataforma Acad√©mica FIEE - UNI</title>
    <style>
        :root { --uni: #800000; --bg: #f8fafc; --text: #334155; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        
        .btn { background: var(--uni); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; box-sizing: border-box; text-decoration: none; display: inline-block; text-align: center; transition: background 0.2s; }
        .btn:hover { background: #600000; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0 15px 0; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        input:focus, textarea:focus { outline: 2px solid var(--uni); outline-offset: -1px; }
        
        /* Contenedores Base */
        .registro-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .card-login { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); width: 380px; border-top: 6px solid var(--uni); }
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 25px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #64748b; font-weight: 600; transition: 0.3s; }
        .tab:hover { color: var(--uni); }
        .tab.active { color: var(--uni); border-bottom: 3px solid var(--uni); margin-bottom: -2px; }
        .form-view { display: none; animation: fadeIn 0.3s ease; }
        .form-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Layout Examen y Capas de Video */
        .examen-layout { display: flex; height: 100vh; overflow: hidden; width: 100vw; }
        .examen-area { flex: 2.5; padding: 40px; overflow-y: auto; background: white; border-right: 1px solid #e2e8f0; }
        .proctoring-sidebar { flex: 1; padding: 25px; display: flex; flex-direction: column; align-items: center; background: #f8fafc; }
        
        .video-container { position: relative; width: 100%; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); background: #000; }
        #video-alumno { width: 100%; display: block; transform: scaleX(-1); }
        #overlay-ia { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; transform: scaleX(-1); pointer-events: none; }
        
        .status-badge { padding: 10px 20px; border-radius: 50px; font-weight: 600; width: 100%; text-align: center; margin-top:15px; box-sizing: border-box; border: 1px solid #cbd5e1; transition: 0.3s; }
        .log-box { width: 100%; margin-top: 20px; flex-grow: 1; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; font-size: 13px; background: white; }
        .pregunta-card { background: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }

        /* Dashboard Docente */
        .dash-body { padding: 30px; overflow-y: auto; height: 100vh; box-sizing: border-box;}
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 25px; align-items: center;}
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; border-top: 4px solid var(--uni); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
        .stat-card h2 { margin: 0; color: var(--text); font-size: 32px; font-weight: 800; }
        .dash-layout { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        .panel { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
        .evidencia-card { display: flex; border: 1px solid #fecaca; border-radius: 8px; overflow: hidden; margin-bottom: 15px; background: white; }
        .evidencia-card img { width: 130px; height: 100px; object-fit: cover; border-right: 1px solid #fecaca;}

        /* --- TEMA OSCURO --- */
        body.dark-theme { --bg: #0f172a; --text: #e2e8f0; }
        body.dark-theme .examen-area, body.dark-theme .proctoring-sidebar, body.dark-theme .panel, body.dark-theme .stat-card, body.dark-theme .log-box { background: #1e293b; border-color: #334155; color: #e2e8f0; }
        body.dark-theme .pregunta-card, body.dark-theme .evidencia-card { background: #0f172a; border-color: #334155; }
        body.dark-theme input, body.dark-theme textarea, body.dark-theme select { background: #1e293b; color: white; border-color: #475569; }
        body.dark-theme .status-badge { background: #334155 !important; border-color: #475569 !important; }
    </style>
</head>
<body>

    {% if vista == 'registro' %}
    <div class="registro-container">
        <div class="card-login">
            <h2 style="text-align: center; color: var(--uni); margin-top:0; font-weight:800;">PROCTORING FIEE</h2>
            <div class="tabs">
                <div id="tab-est" class="tab active" onclick="cambiarTab('est')">Estudiante</div>
                <div id="tab-doc" class="tab" onclick="cambiarTab('doc')">Docente</div>
            </div>
            
            <div id="view-estudiante" class="form-view active">
                <form action="/ingresar_alumno" method="post">
                    <input type="text" name="nombre" placeholder="Nombres Completos" required>
                    <input type="text" name="uid" placeholder="C√≥digo UNI (Ej: 20261234A)" required>
                    <input type="text" name="sala" placeholder="C√≥digo de la Sala" required style="text-transform: uppercase;">
                    <button type="submit" class="btn">Acceder a Evaluaci√≥n</button>
                </form>
            </div>
            
            <div id="view-docente" class="form-view">
                <form id="form-doc-login" action="/login_docente" method="post">
                    <input type="text" name="docente" placeholder="Usuario Docente" required>
                    <input type="password" name="password" placeholder="Contrase√±a" required>
                    <button type="submit" class="btn" style="background:#334155; margin-bottom: 15px;">Ingresar a Panel</button>
                    <hr style="border:0; border-top:1px solid #e2e8f0; margin:20px 0;">
                    <button type="button" class="btn" style="background:#10b981;" onclick="mostrarCrearSala(true)">Crear Entorno de Evaluaci√≥n</button>
                </form>

                <form id="form-doc-crear" action="/crear_sala" method="post" style="display:none;">
                    <input type="text" name="docente" placeholder="Usuario Docente" required>
                    <input type="text" name="nombre_sala" placeholder="Nombre de Nueva Sala" required style="text-transform: uppercase;">
                    <input type="password" name="password" placeholder="Establece una Contrase√±a" required>
                    <button type="submit" class="btn" style="background:#10b981; margin-bottom:15px;">Crear Entorno</button>
                    <button type="button" class="btn" style="background:#94a3b8;" onclick="mostrarCrearSala(false)">Volver al Login</button>
                </form>
            </div>

        </div>
    </div>
    <script>
        // Funci√≥n principal de cambio de pesta√±as CORREGIDA
        function cambiarTab(tipo) {
            // 1. Resetear botones de pesta√±as
            document.getElementById('tab-est').classList.toggle('active', tipo === 'est');
            document.getElementById('tab-doc').classList.toggle('active', tipo === 'doc');
            
            // 2. Mostrar/Ocultar contenedores principales
            document.getElementById('view-estudiante').classList.toggle('active', tipo === 'est');
            document.getElementById('view-docente').classList.toggle('active', tipo === 'doc');

            // 3. LA CORRECCI√ìN: Resetear el estado interno de la vista de docente
            // Siempre volver a mostrar el login y esconder la creaci√≥n de sala al cambiar de tab.
            mostrarCrearSala(false);
        }

        // Funci√≥n auxiliar para navegar DENTRO de la pesta√±a de docente
        function mostrarCrearSala(quiereCrear) {
            const formLogin = document.getElementById('form-doc-login');
            const formCrear = document.getElementById('form-doc-crear');

            if (quiereCrear) {
                formLogin.style.display = 'none';
                formCrear.style.display = 'block';
            } else {
                formLogin.style.display = 'block';
                formCrear.style.display = 'none';
            }
        }
    </script>
    {% endif %}

    {% if vista == 'examen' %}
    <div class="examen-layout">
        <div class="examen-area">
            <h2 style="color: var(--uni); margin-top:0; font-weight:800;">Aula de Evaluaci√≥n: {{ sala }}</h2>
            <div style="background:#f0f9ff; padding:15px; border-radius:8px; font-size:13px; margin-bottom:25px; border-left:4px solid #0ea5e9; color:#0369a1;">
                üõ°Ô∏è <b>Auditor√≠a Activa:</b> El docente no puede acceder a las camaras, solo a las incidencias.
                <button type="button" class="btn" onclick="document.body.classList.toggle('dark-theme')" style="width: auto; padding: 6px 12px; font-size: 12px; background: #334155; margin-bottom: 15px;">üåô Alternar Modo Oscuro</button>
            </div>

            {% if config.tipo == 'tradicional' %}
                <img src="{{ config.url }}" style="width: 100%; border: 1px solid #e2e8f0; border-radius: 8px;">
                <h3 style="margin-top:25px;">Hoja de Respuestas:</h3>
                <textarea id="resp_txt" style="height: 200px;" placeholder="Digita el desarrollo de los problemas aqu√≠..."></textarea>
            {% else %}
                <div id="quiz-interactivo">
                    {% for preg in config.preguntas %}
                    <div class="pregunta-card">
                        <p style="margin-top:0; font-size:16px;"><b>{{ loop.index }}. {{ preg.pregunta }}</b></p>
                        {% for opc in preg.opciones %}
                        <label style="display:block; padding:12px 15px; border:1px solid #e2e8f0; margin-top:8px; border-radius:6px; cursor:pointer;">
                            <input type="radio" name="preg_{{ loop.index0 }}" value="{{ opc }}"> {{ opc }}
                        </label>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="proctoring-sidebar">
            <div style="background:var(--uni); color:white; width:100%; padding:15px; text-align:center; border-radius:8px; margin-bottom:20px; box-sizing:border-box;">
                <span style="font-size:16px; font-weight:bold; display:block; margin-bottom:4px;">{{ nombre }}</span>
                <span style="font-size:12px; opacity:0.9;">C√≥digo: {{ uid }}</span>
            </div>
            
            <div class="video-container">
                <video id="video-alumno" autoplay playsinline></video>
                <canvas id="overlay-ia"></canvas> </div>
            
            <canvas id="canvas-oculto" style="display:none" width="640" height="480"></canvas>
            <div id="estado" class="status-badge" style="color:#d97706; border-color:#fcd34d; background:#fffbeb;">‚è≥ Iniciando Motor ONNX...</div>
            
            <form action="/finalizar_evaluacion" method="post" style="width: 100%; margin-top:15px;" onsubmit="recopilarRespuestas()">
                <input type="hidden" name="uid" value="{{ uid }}">
                <input type="hidden" name="respuestas" id="input_respuestas">
                <button type="submit" class="btn" style="background:#10b981; font-size:16px;">üèÅ ENTREGAR PRUEBA</button>
            </form>

            <div class="log-box">
                <span style="color:#64748b; font-weight:bold; font-size:11px; text-transform:uppercase;">Log de Eventos IA</span>
                <hr style="border:0; border-top:1px solid #e2e8f0; margin:10px 0;">
                <div id="lista-eventos"></div>
            </div>
        </div>
    </div>
    <script>
        const DATOS_ALUMNO = { uid: "{{ uid }}", nombre: "{{ nombre }}", sala: "{{ sala }}" };
        function recopilarRespuestas() {
            let data = {};
            if (document.getElementById('resp_txt')) {
                data.texto = document.getElementById('resp_txt').value;
            } else {
                document.querySelectorAll('.pregunta-card').forEach((q, index) => {
                    const checked = q.querySelector(`input[name="preg_${index}"]:checked`);
                    data[`Pregunta_${index+1}`] = checked ? checked.value : "Sin Responder";
                });
            }
            document.getElementById('input_respuestas').value = JSON.stringify(data);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script src="/static/js/motor_ia.js"></script>
    {% endif %}

    {% if vista == 'dashboard' %}
    <div class="dash-body">
        <div class="header">
            <div>
                <h1 style="color: var(--uni); margin: 0; font-weight:800;">üë®‚Äçüè´ Centro de Mando</h1>
                <p style="margin:5px 0 0 0; color:#64748b; font-size:14px;">Docente: <b style="color:var(--text);">{{ docente }}</b> | Sala: <b style="color:var(--uni);">{{ sala }}</b></p>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="location.reload()" style="width:auto; background:white; color:var(--text); border:1px solid #cbd5e1;">üîÑ Refrescar Red</button>
                <a href="/descargar_excel/asistencia" class="btn" style="background:#0284c7; width:auto; border-bottom: 3px solid #0369a1;">üìä Excel: Asistencia y Rptas</a>
                <a href="/descargar_excel/infracciones" class="btn" style="background:#e11d48; width:auto; border-bottom: 3px solid #be123c;">üö® Excel: Infracciones IA</a>
                
                <form action="/limpiar_auditoria" method="post" onsubmit="return confirm('ATENCI√ìN: Borrar√° irreversiblemente las fotos del servidor. ¬øContinuar?');" style="margin:0;">
                    <button type="submit" class="btn" style="background:#ef4444; width:auto;">üóëÔ∏è Purgar Data</button>
                </form>
                <a href="/logout" class="btn" style="background:#334155; width:auto;">Salir</a>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><h2>{{ stats.total_alumnos }}</h2><p>ALUMNOS</p></div>
            <div class="stat-card"><h2 style="color:#10b981;">{{ stats.activos }}</h2><p>RINDIENDO AHORA</p></div>
            <div class="stat-card"><h2 style="color:#ef4444;">{{ stats.total_alertas }}</h2><p>INCIDENTES GLOBALES</p></div>
            <div class="stat-card"><h2 style="color:{{ '#ef4444' if stats.camaras_tapadas > 0 else '#10b981' }}">{{ stats.camaras_tapadas }}</h2><p>SABOTAJES HARDWARE</p></div>
        </div>

        <div class="dash-layout">
            <div class="panel">
                <h3 style="margin-top:0; color:var(--uni); border-bottom: 2px solid #f1f5f9; padding-bottom:10px; font-size:16px;">Configuraci√≥n de Evaluaci√≥n</h3>
                <form action="/configurar_lms" method="post">
                    <label style="font-size:12px; font-weight:bold; color:#64748b;">FORMATO DE ENTREGA:</label>
                    <select name="tipo">
                        <option value="tradicional">Archivo Gr√°fico (Hoja de Preguntas)</option>
                        <option value="interactivo">Despliegue Din√°mico (JSON Array)</option>
                    </select>
                    <label style="font-size:12px; font-weight:bold; color:#64748b; margin-top:10px; display:block;">CONTENIDO ENCRIPTADO:</label>
                    <textarea name="contenido" rows="6" placeholder="Ingrese el URL del documento o la matriz JSON aqu√≠..." required></textarea>
                    <button type="submit" class="btn" style="background:#10b981; margin-top:10px;">Aplicar Par√°metros a la Sala</button>
                </form>
                
                <div style="margin-top: 35px; background: #faf5ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                    <h4 style="margin-top:0; color:#0369a1; font-size:14px;">Conexiones Activas (Sockets)</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        {% for est in asistencia %}
                        <div style="font-size:12px; margin-bottom:10px; border-bottom:1px solid #e0f2fe; padding-bottom:10px;">
                            <b>{{ est.Nombre }}</b> ({{ est.ID }})<br>
                            Status: <span style="font-weight:bold; color:{{ '#10b981' if est.Estado == 'EN EXAMEN' else '#64748b' }}">{{ est.Estado }}</span> | 
                            Video: <span style="font-weight:bold; color:{{ '#ef4444' if est.Camara == 'BLOQUEADA' else '#10b981' }}">{{ est.Camara }}</span>
                        </div>
                        {% else %}
                        <p style="color:#94a3b8; font-size:12px;">Esperando handshake de clientes...</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="panel">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                    <div>
                        <h3 style="margin-top:0; color:var(--uni); border-bottom: 2px solid #f1f5f9; padding-bottom:10px; font-size:16px;">Auditor√≠a Forense IA</h3>
                        <div style="max-height: 600px; overflow-y: auto; padding-right:10px;">
                            {% for item in incidencias %}
                            <div class="evidencia-card">
                                <img src="/ver_evidencia/{{ item.Ruta.split('/')[-1] }}" loading="lazy">
                                <div style="padding: 12px; font-size:12px; width:100%;">
                                    <span style="background:#fee2e2; color:#b91c1c; padding:3px 6px; border-radius:4px; font-weight:bold; font-size:10px;">{{ item.Falta }}</span><br>
                                    <div style="margin-top:8px;"><b>{{ item.Nombre }}</b></div>
                                    <div style="color:#64748b; margin-top:2px;">{{ item.Fecha }}</div>
                                </div>
                            </div>
                            {% else %}
                            <div style="text-align:center; padding:40px 20px; background:#f8fafc; border-radius:8px; border:1px dashed #e2e8f0;">
                                <p style="color:#94a3b8; font-size:13px; margin:0;">El entorno de evaluaci√≥n es seguro.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div>
                        <h3 style="margin-top:0; color:var(--uni); border-bottom: 2px solid #f1f5f9; padding-bottom:10px; font-size:16px;">Payloads Entregados</h3>
                        <div style="max-height: 600px; overflow-y: auto; padding-right:10px;">
                            {% for res in respuestas %}
                            <div style="background:white; border:1px solid #e2e8f0; border-left:4px solid #10b981; padding:15px; margin-bottom:15px; border-radius:6px; font-size:12px; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);">
                                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                    <b>Alumno: {{ res.ID }}</b> 
                                    <span style="color:#64748b;">{{ res.Fecha }}</span>
                                </div>
                                <hr style="border:0; border-top:1px dashed #e2e8f0; margin: 8px 0 10px 0;">
                                {% for p, r in res.Detalle.items() %}
                                    <div style="margin-bottom:4px;"><span style="color:#64748b;">{{ p }}:</span> <b>{{ r }}</b></div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div style="text-align:center; padding:40px 20px; background:#f8fafc; border-radius:8px; border:1px dashed #e2e8f0;">
                                <p style="color:#94a3b8; font-size:13px; margin:0;">En espera de POST requests...</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if vista == 'confirmacion' %}
    <div style="display:flex; justify-content:center; align-items:center; height:100vh;">
        <div style="background:white; padding:50px; border-radius:12px; box-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1); text-align:center; border-top:6px solid #10b981;">
            <h1 style="color:#10b981; margin-top:0; font-weight:800;">TRANSMISI√ìN EXITOSA</h1>
            <p style="color:#64748b; font-size:16px;">Tus respuestas y auditor√≠a han sido enviadas.</p>
            <button onclick="location.href='/'" class="btn" style="margin-top:25px; width:auto; padding:12px 35px; background:#334155;">Finalizar Sesi√≥n</button>
        </div>
    </div>
    {% endif %}

    {% if vista == 'error' %}
    <div style="display:flex; justify-content:center; align-items:center; height:100vh;">
        <div style="background:white; padding:50px; border-radius:12px; box-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1); text-align:center; border-top:6px solid #ef4444;">
            <h1 style="color:#ef4444; margin-top:0; font-weight:800;">{{ titulo }}</h1>
            <p style="color:#64748b; font-size:16px; margin-bottom:25px;">{{ mensaje }}</p>
            <button onclick="location.href='/'" class="btn" style="width:auto; padding:12px 35px; background:#334155;">Volver al Inicio Seguramente</button>
        </div>
    </div>
    {% endif %}

</body>
</html>
